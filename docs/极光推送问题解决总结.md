# 极光推送集成问题解决总结

## 问题背景
在Mac上使用`npx expo run:android`运行应用时，出现错误：
```
TypeError: _jpushReactNative.default.addReceiveNotificationListener is not a function (it is undefined)
```

## 根本原因
**API变更**：jpush-react-native 3.2.0版本更改了API命名，监听器方法名发生了变化

## 解决步骤

### 1. ✅ 版本环境梳理
```
React Native: 0.79.5 (2024年新版本)
React: 19.0.0
Expo: 53.0.20
jpush-react-native: 3.2.0 (最新版本)
jcore-react-native: 2.3.1
```

### 2. ✅ API方法名变更 (3.2.0版本)
旧版本API → 新版本API：
```javascript
// ❌ 旧方法名（3.1.x及以下）
JPush.addReceiveNotificationListener()      
JPush.addReceiveOpenNotificationListener()  
JPush.addReceiveCustomMsgListener()         

// ✅ 新方法名（3.2.0）
JPush.addNotificationListener()        // 接收通知
JPush.addLocalNotificationListener()   // 本地通知/打开通知
JPush.addCustomMessageListener()       // 自定义消息
```

### 3. ✅ 更新代码以适配新API
修改 `/utils/JPushService.ts` 中的监听器注册代码：
```javascript
// 使用3.2.0版本的新API
JPush.addNotificationListener((notification) => {
  console.log('[JPush] 收到远程通知:', notification);
});

JPush.addLocalNotificationListener((notification) => {
  console.log('[JPush] 打开通知:', notification);
});

JPush.addCustomMessageListener((message) => {
  console.log('[JPush] 收到自定义消息:', message);
});
```

### 4. ✅ 重新生成原生代码
```bash
# 清理并重新生成
npx expo prebuild --clean

# 清理Android缓存
cd android && ./gradlew clean && cd ..

# 重新运行
npx expo run:android
```

## 当前状态
- ✅ 已升级到最新版本3.2.0
- ✅ 已更新代码以适配新API
- ✅ 已清理构建缓存
- ✅ API方法名问题已解决

## 后续验证步骤

### 1. 检查初始化日志
应该看到：
```
[JPush] 开始初始化...
[JPush] 初始化成功
[JPush] 获取到RegistrationID: xxxxx
```
而不是之前的错误。

### 2. 版本兼容性说明

#### jpush-react-native版本对照表：
| 版本 | API风格 | 适配的RN版本 |
|------|---------|-------------|
| 2.x | 旧API (addReceiveXxxListener) | RN 0.50-0.72 |
| 3.0-3.1 | 旧API (addReceiveXxxListener) | RN 0.60-0.73 |
| 3.2.0 | 新API (addXxxListener) | RN 0.70+ |

#### 注意事项：
- 3.2.0版本简化了API命名，去掉了`Receive`前缀
- 如需使用旧版本文档，请注意API方法名的差异
- React Native 0.79.5完全兼容jpush-react-native 3.2.0

## 测试要点

1. **在真机测试**
   - iOS必须真机（模拟器不支持推送）
   - Android建议真机或支持Google Play的模拟器

2. **API地址配置**
   - 确保`.env`中的`EXPO_PUBLIC_API_URL`正确
   - Android模拟器：`http://10.0.2.2:3000`
   - 真机：局域网IP

3. **后端服务**
   - 确保后端API服务正常运行
   - 检查设备注册接口是否可访问

## 相关文件
- `/utils/JPushService.ts` - 推送服务
- `/app/_layout.tsx` - 初始化位置
- `/contexts/AppContext.tsx` - 推送状态管理
- `/.env` - 环境配置

## 联系支持
如果问题持续：
1. 在[jpush-react-native GitHub](https://github.com/jpush/jpush-react-native/issues)提issue
2. 查看是否有其他人遇到React Native 0.79兼容性问题
3. 考虑降级React Native到0.73.x（更稳定）