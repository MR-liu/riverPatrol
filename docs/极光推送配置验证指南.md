# 极光推送(JPush)配置验证指南

## 当前配置状态检查 ❌

经过检查，发现以下问题：

### 1. 缺少的配置
- ❌ Android原生配置未完成
- ❌ iOS原生配置未完成 
- ❌ app.json中未配置JPush插件
- ❌ 缺少jpush-config.json配置文件

### 2. 已完成的部分
- ✅ 已安装jpush-react-native: ^3.2.0
- ✅ 已安装jcore-react-native: ^2.3.1  
- ✅ JPushService.ts已实现
- ✅ 推送配置界面已创建
- ✅ AppContext已集成推送功能

## 配置步骤

### 步骤1: 获取极光推送AppKey

1. 访问[极光推送官网](https://www.jiguang.cn/)
2. 注册并登录账号
3. 创建应用，获取AppKey
4. 记录你的AppKey（格式：xxxxxxxxxxxxxxxxxxxxxx）

### 步骤2: 配置jpush-config.json

编辑 `/jpush-config.json` 文件：

```json
{
  "appKey": "你的极光AppKey", 
  "channel": "default",
  "production": false
}
```

### 步骤3: 配置React Native原生部分

由于你使用的是Expo管理的工作流，需要先执行prebuild：

```bash
# 生成原生代码
npx expo prebuild

# 清理并重新构建（如果需要）
npx expo prebuild --clean
```

### 步骤4: Android配置

#### 4.1 自动链接（React Native 0.60+）
```bash
cd android
./gradlew clean
cd ..
```

#### 4.2 手动配置MainApplication.java
文件路径：`android/app/src/main/java/.../MainApplication.java`

添加以下导入：
```java
import cn.jpush.reactnativejpush.JPushPackage;
```

#### 4.3 配置AndroidManifest.xml
在 `android/app/src/main/AndroidManifest.xml` 中添加：

```xml
<!-- 极光推送权限 -->
<uses-permission android:name="${applicationId}.permission.JPUSH_MESSAGE" />
<permission
    android:name="${applicationId}.permission.JPUSH_MESSAGE"
    android:protectionLevel="signature" />

<!-- 在application标签内添加 -->
<meta-data android:name="JPUSH_CHANNEL" android:value="default" />
<meta-data android:name="JPUSH_APPKEY" android:value="你的AppKey" />
```

### 步骤5: iOS配置

#### 5.1 Pod安装
```bash
cd ios
pod install
cd ..
```

#### 5.2 配置Info.plist
在 `ios/RiverPatrol/Info.plist` 中添加：

```xml
<key>JPushAppKey</key>
<string>你的AppKey</string>
<key>JPushChannel</key>
<string>default</string>
<key>JPushProduction</key>
<false/>
```

#### 5.3 配置推送能力
1. 打开Xcode
2. 选择项目 -> Signing & Capabilities
3. 添加 Push Notifications capability
4. 添加 Background Modes capability，勾选 Remote notifications

### 步骤6: 初始化代码验证

在 `app/_layout.tsx` 中确认已添加初始化：

```typescript
import JPushService from '@/utils/JPushService';

export default function RootLayout() {
  useEffect(() => {
    // 初始化极光推送
    JPushService.initialize().then(() => {
      console.log('JPush初始化成功');
    }).catch(error => {
      console.error('JPush初始化失败:', error);
    });
  }, []);
  
  // ... 其他代码
}
```

## 验证方法

### 1. 基础验证
```bash
# 启动应用
npx expo run:android
# 或
npx expo run:ios
```

查看控制台输出：
- 应看到 "[JPush] 初始化成功"
- 应看到 "[JPush] 获取到RegistrationID: xxxxx"

### 2. RegistrationID验证
在应用中添加测试按钮：

```typescript
import JPushService from '@/utils/JPushService';

const testJPush = async () => {
  const regId = await JPushService.getRegistrationId();
  console.log('RegistrationID:', regId);
  Alert.alert('RegistrationID', regId || '未获取到');
};
```

### 3. 推送测试

#### 方法1：通过极光控制台
1. 登录极光推送控制台
2. 选择你的应用
3. 点击"推送" -> "发送通知"
4. 输入RegistrationID或选择全部设备
5. 发送测试消息

#### 方法2：通过APP内测试
1. 打开应用
2. 进入"推送设置"页面
3. 点击"测试推送"按钮
4. 检查是否收到通知

### 4. 日志查看

#### Android日志
```bash
adb logcat | grep JPush
```

#### iOS日志
在Xcode控制台查看JPush相关日志

## 常见问题

### 1. 获取不到RegistrationID
- 检查网络连接
- 确认AppKey配置正确
- 查看日志是否有错误信息

### 2. Android收不到推送
- 检查是否在后台被系统杀死
- 检查通知权限是否开启
- 某些手机需要在设置中允许自启动

### 3. iOS收不到推送
- 检查推送证书配置
- 确认在真机上测试（模拟器不支持推送）
- 检查是否正确配置了APN证书

### 4. 初始化失败
- 检查jpush-react-native版本兼容性
- 尝试重新链接原生库：
  ```bash
  npx react-native unlink jpush-react-native
  npx react-native link jpush-react-native
  ```

## 测试检查清单

- [ ] jpush-config.json已配置AppKey
- [ ] Android原生配置完成
- [ ] iOS原生配置完成（如需要）
- [ ] 应用启动时能看到JPush初始化日志
- [ ] 能获取到RegistrationID
- [ ] 能收到测试推送通知
- [ ] 点击通知能正确处理
- [ ] 推送设置页面功能正常

## 后续步骤

完成配置后：
1. 在真机上测试推送功能
2. 配置生产环境的推送证书
3. 实现推送数据统计
4. 优化推送到达率

## 相关资源

- [极光推送官方文档](https://docs.jiguang.cn/jpush/client/client_plugins/)
- [jpush-react-native GitHub](https://github.com/jpush/jpush-react-native)
- [Expo推送通知文档](https://docs.expo.dev/push-notifications/overview/)