# APPÁ´ØÊé®ÈÄÅÈÄöÁü•Êé•ÂÖ•ÊåáÂçó

## ÁõÆÂΩï
1. [Ê¶ÇËø∞](#Ê¶ÇËø∞)
2. [ÊûÅÂÖâÊé®ÈÄÅSDKÈõÜÊàê](#ÊûÅÂÖâÊé®ÈÄÅsdkÈõÜÊàê)
3. [ËÆæÂ§áÊ≥®ÂÜåÊµÅÁ®ã](#ËÆæÂ§áÊ≥®ÂÜåÊµÅÁ®ã)
4. [APIÊé•Âè£ÊñáÊ°£](#apiÊé•Âè£ÊñáÊ°£)
5. [Êé®ÈÄÅÊ∂àÊÅØÂ§ÑÁêÜ](#Êé®ÈÄÅÊ∂àÊÅØÂ§ÑÁêÜ)
6. [ÊµãËØï‰∏éË∞ÉËØï](#ÊµãËØï‰∏éË∞ÉËØï)

---

## Ê¶ÇËø∞

Êô∫ÊÖßÊ≤≥ÈÅìÁõëÊéßÁ≥ªÁªü‰ΩøÁî®**ÊûÅÂÖâÊé®ÈÄÅÔºàJPushÔºâ**‰Ωú‰∏∫ÁßªÂä®Á´ØÊ∂àÊÅØÊé®ÈÄÅÊúçÂä°ÔºåÊîØÊåÅiOSÂíåAndroidÂèåÂπ≥Âè∞„ÄÇ

### Ê†∏ÂøÉÂäüËÉΩ
- üîî ÂÆûÊó∂Êé®ÈÄÅÈÄöÁü•ÔºàÂëäË≠¶„ÄÅÂ∑•Âçï„ÄÅÁ≥ªÁªüÂÖ¨ÂëäÁ≠âÔºâ
- üì± ËÆæÂ§áÊ≥®ÂÜå‰∏éÁÆ°ÁêÜ
- üìä Êé®ÈÄÅÁªüËÆ°‰∏éËøΩË∏™
- üéØ Á≤æÂáÜÊé®ÈÄÅÔºàÊåâÁî®Êà∑„ÄÅËßíËâ≤„ÄÅÂÖ®ÂëòÔºâ

### ÈÖçÁΩÆ‰ø°ÊÅØ
```
AppKey: 463f52032571434a7a2ddeee
MasterSecret: dae68cd8344bdd329d032915
Channel: developer (ÂºÄÂèë) / App Store (Áîü‰∫ß)
```

---

## ÊûÅÂÖâÊé®ÈÄÅSDKÈõÜÊàê

### 1. React NativeÈõÜÊàê

#### ÂÆâË£Ö‰æùËµñ
```bash
npm install jpush-react-native --save
npm install jcore-react-native --save

# iOSÈ¢ùÂ§ñÈÖçÁΩÆ
cd ios && pod install
```

#### ÂàùÂßãÂåñ‰ª£Á†Å
```javascript
import JPush from 'jpush-react-native'

// App.js Êàñ index.js
export default class App extends Component {
  componentDidMount() {
    // ÂàùÂßãÂåñJPush
    JPush.init()
    
    // ËÆæÁΩÆË∞ÉËØïÊ®°ÂºèÔºàÂºÄÂèëÁéØÂ¢ÉÂºÄÂêØÔºâ
    if (__DEV__) {
      JPush.setLoggerEnable(true)
    }
    
    // Ëé∑ÂèñRegistrationID
    JPush.getRegistrationID((registrationId) => {
      console.log("JPush RegistrationID: " + registrationId)
      // Ê≥®ÂÜåËÆæÂ§áÂà∞ÊúçÂä°Âô®
      this.registerDevice(registrationId)
    })
    
    // ÁõëÂê¨Êé®ÈÄÅÊ∂àÊÅØ
    this.setupNotificationListeners()
  }
  
  setupNotificationListeners() {
    // Êî∂Âà∞Êé®ÈÄÅÊ∂àÊÅØÔºàAPPÂú®ÂâçÂè∞Ôºâ
    JPush.addReceiveNotificationListener((message) => {
      console.log("Êî∂Âà∞Êé®ÈÄÅÊ∂àÊÅØ: ", message)
      this.handleNotification(message)
    })
    
    // ÁÇπÂáªÊé®ÈÄÅÊ∂àÊÅØ
    JPush.addReceiveOpenNotificationListener((message) => {
      console.log("ÁÇπÂáªÊé®ÈÄÅÊ∂àÊÅØ: ", message)
      this.handleNotificationClick(message)
    })
    
    // Êî∂Âà∞Ëá™ÂÆö‰πâÊ∂àÊÅØ
    JPush.addReceiveCustomMsgListener((message) => {
      console.log("Êî∂Âà∞Ëá™ÂÆö‰πâÊ∂àÊÅØ: ", message)
      this.handleCustomMessage(message)
    })
  }
  
  // Ê≥®ÂÜåËÆæÂ§á
  async registerDevice(registrationId) {
    try {
      const response = await fetch('https://your-server.com/api/app-device-register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getAuthToken()
        },
        body: JSON.stringify({
          jpush_registration_id: registrationId,
          device_type: Platform.OS,
          device_model: DeviceInfo.getModel(),
          os_version: DeviceInfo.getSystemVersion(),
          app_version: DeviceInfo.getVersion()
        })
      })
      
      const result = await response.json()
      if (result.success) {
        console.log('ËÆæÂ§áÊ≥®ÂÜåÊàêÂäü')
      }
    } catch (error) {
      console.error('ËÆæÂ§áÊ≥®ÂÜåÂ§±Ë¥•:', error)
    }
  }
  
  // Â§ÑÁêÜÈÄöÁü•ÁÇπÂáª
  handleNotificationClick(message) {
    const extras = message.extras || {}
    
    switch (extras.template_code) {
      case 'ALARM_NEW':
        // Ë∑≥ËΩ¨Âà∞ÂëäË≠¶ËØ¶ÊÉÖ
        this.props.navigation.navigate('AlarmDetail', { 
          alarmId: extras.alarmId 
        })
        break
        
      case 'WORKORDER_ASSIGNED':
        // Ë∑≥ËΩ¨Âà∞Â∑•ÂçïËØ¶ÊÉÖ
        this.props.navigation.navigate('WorkOrderDetail', { 
          orderId: extras.orderId 
        })
        break
        
      case 'SYSTEM_NOTIFICATION':
        // Ë∑≥ËΩ¨Âà∞ÈÄöÁü•‰∏≠ÂøÉ
        this.props.navigation.navigate('NotificationCenter', {
          notificationId: extras.notificationId
        })
        break
        
      default:
        // ÈªòËÆ§Ë∑≥ËΩ¨Âà∞ÈÄöÁü•ÂàóË°®
        this.props.navigation.navigate('Notifications')
    }
    
    // Ê†áËÆ∞ÈÄöÁü•‰∏∫Â∑≤ËØª
    if (extras.notificationId) {
      this.markAsRead(extras.notificationId)
    }
  }
}
```

### 2. AndroidÂéüÁîüÈõÜÊàê

#### build.gradleÈÖçÁΩÆ
```gradle
android {
    defaultConfig {
        applicationId "com.smartriver.monitor"
        
        manifestPlaceholders = [
            JPUSH_APPKEY: "463f52032571434a7a2ddeee",
            JPUSH_CHANNEL: "developer"
        ]
    }
}

dependencies {
    implementation 'cn.jiguang.sdk:jpush:4.9.0'
    implementation 'cn.jiguang.sdk:jcore:3.3.0'
}
```

#### MainActivity.java
```java
import cn.jpush.android.api.JPushInterface;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        // ËÆæÁΩÆË∞ÉËØïÊ®°Âºè
        JPushInterface.setDebugMode(BuildConfig.DEBUG);
        
        // ÂàùÂßãÂåñJPush
        JPushInterface.init(this);
        
        // Ëé∑ÂèñRegistrationID
        String registrationId = JPushInterface.getRegistrationID(this);
        Log.d("JPush", "RegistrationID: " + registrationId);
        
        // Ê≥®ÂÜåËÆæÂ§á
        if (!TextUtils.isEmpty(registrationId)) {
            registerDevice(registrationId);
        }
    }
    
    private void registerDevice(String registrationId) {
        // Ë∞ÉÁî®APIÊ≥®ÂÜåËÆæÂ§á
        ApiService.getInstance().registerDevice(
            registrationId,
            "Android",
            Build.MODEL,
            Build.VERSION.RELEASE,
            BuildConfig.VERSION_NAME
        );
    }
}
```

#### JPushReceiver.java
```java
public class JPushReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        Bundle bundle = intent.getExtras();
        
        if (JPushInterface.ACTION_REGISTRATION_ID.equals(intent.getAction())) {
            // Ëé∑ÂèñÂà∞RegistrationID
            String regId = bundle.getString(JPushInterface.EXTRA_REGISTRATION_ID);
            Log.d("JPush", "Êé•Êî∂Âà∞RegistrationID: " + regId);
            // ‰øùÂ≠òÂπ∂‰∏äÊä•Âà∞ÊúçÂä°Âô®
            
        } else if (JPushInterface.ACTION_NOTIFICATION_RECEIVED.equals(intent.getAction())) {
            // Êî∂Âà∞Êé®ÈÄÅÈÄöÁü•
            String title = bundle.getString(JPushInterface.EXTRA_NOTIFICATION_TITLE);
            String content = bundle.getString(JPushInterface.EXTRA_ALERT);
            String extras = bundle.getString(JPushInterface.EXTRA_EXTRA);
            
            Log.d("JPush", "Êî∂Âà∞ÈÄöÁü•: " + title + " - " + content);
            
        } else if (JPushInterface.ACTION_NOTIFICATION_OPENED.equals(intent.getAction())) {
            // Áî®Êà∑ÁÇπÂáª‰∫ÜÈÄöÁü•
            handleNotificationClick(context, bundle);
        }
    }
    
    private void handleNotificationClick(Context context, Bundle bundle) {
        String extras = bundle.getString(JPushInterface.EXTRA_EXTRA);
        try {
            JSONObject json = new JSONObject(extras);
            String templateCode = json.optString("template_code");
            
            Intent intent = new Intent(context, MainActivity.class);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            
            switch (templateCode) {
                case "ALARM_NEW":
                    intent.putExtra("page", "alarm_detail");
                    intent.putExtra("alarmId", json.optString("alarmId"));
                    break;
                    
                case "WORKORDER_ASSIGNED":
                    intent.putExtra("page", "workorder_detail");
                    intent.putExtra("orderId", json.optString("orderId"));
                    break;
                    
                default:
                    intent.putExtra("page", "notifications");
                    break;
            }
            
            context.startActivity(intent);
            
        } catch (JSONException e) {
            e.printStackTrace();
        }
    }
}
```

### 3. iOSÂéüÁîüÈõÜÊàê

#### AppDelegate.swift
```swift
import UserNotifications
import JPush

@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate {
    
    func application(_ application: UIApplication, 
                    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        
        // ÂàùÂßãÂåñJPush
        let entity = JPUSHRegisterEntity()
        entity.types = Int(JPAuthorizationOptions.alert.rawValue) |
                      Int(JPAuthorizationOptions.badge.rawValue) |
                      Int(JPAuthorizationOptions.sound.rawValue)
        
        JPUSHService.register(forRemoteNotificationConfig: entity, delegate: self)
        
        // ÈÖçÁΩÆJPush
        #if DEBUG
        JPUSHService.setup(withOption: launchOptions,
                          appKey: "463f52032571434a7a2ddeee",
                          channel: "developer",
                          apsForProduction: false)
        #else
        JPUSHService.setup(withOption: launchOptions,
                          appKey: "463f52032571434a7a2ddeee",
                          channel: "App Store",
                          apsForProduction: true)
        #endif
        
        // Ëé∑ÂèñRegistrationID
        JPUSHService.registrationIDCompletionHandler { (resCode, registrationID) in
            if resCode == 0 {
                print("JPush RegistrationID: \(registrationID ?? "")")
                self.registerDevice(registrationID)
            }
        }
        
        // ËÆæÁΩÆËßíÊ†á‰∏∫0
        UIApplication.shared.applicationIconBadgeNumber = 0
        JPUSHService.setBadge(0)
        
        return true
    }
    
    // Ê≥®ÂÜåËÆæÂ§á
    func registerDevice(_ registrationId: String?) {
        guard let regId = registrationId else { return }
        
        let params = [
            "jpush_registration_id": regId,
            "device_type": "iOS",
            "device_model": UIDevice.current.model,
            "os_version": UIDevice.current.systemVersion,
            "app_version": Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? ""
        ]
        
        ApiService.shared.registerDevice(params: params) { success in
            if success {
                print("ËÆæÂ§áÊ≥®ÂÜåÊàêÂäü")
            }
        }
    }
}

// MARK: - JPUSHRegisterDelegate
extension AppDelegate: JPUSHRegisterDelegate {
    
    // iOS 10+ ÂâçÂè∞Êî∂Âà∞ÈÄöÁü•
    func jpushNotificationCenter(_ center: UNUserNotificationCenter!, 
                                willPresent notification: UNNotification!, 
                                withCompletionHandler completionHandler: ((Int) -> Void)!) {
        
        let userInfo = notification.request.content.userInfo
        JPUSHService.handleRemoteNotification(userInfo)
        
        // ÊòæÁ§∫ÈÄöÁü•
        completionHandler(Int(UNNotificationPresentationOptions.alert.rawValue | 
                            UNNotificationPresentationOptions.sound.rawValue | 
                            UNNotificationPresentationOptions.badge.rawValue))
    }
    
    // iOS 10+ ÁÇπÂáªÈÄöÁü•
    func jpushNotificationCenter(_ center: UNUserNotificationCenter!, 
                                didReceive response: UNNotificationResponse!, 
                                withCompletionHandler completionHandler: (() -> Void)!) {
        
        let userInfo = response.notification.request.content.userInfo
        JPUSHService.handleRemoteNotification(userInfo)
        
        // Â§ÑÁêÜÈÄöÁü•ÁÇπÂáª
        handleNotificationClick(userInfo: userInfo)
        
        completionHandler()
    }
    
    func handleNotificationClick(userInfo: [AnyHashable: Any]) {
        guard let extras = userInfo["extras"] as? [String: Any],
              let templateCode = extras["template_code"] as? String else {
            return
        }
        
        DispatchQueue.main.async {
            let storyboard = UIStoryboard(name: "Main", bundle: nil)
            
            switch templateCode {
            case "ALARM_NEW":
                if let alarmId = extras["alarmId"] as? String,
                   let vc = storyboard.instantiateViewController(withIdentifier: "AlarmDetailVC") as? AlarmDetailViewController {
                    vc.alarmId = alarmId
                    self.window?.rootViewController?.present(vc, animated: true)
                }
                
            case "WORKORDER_ASSIGNED":
                if let orderId = extras["orderId"] as? String,
                   let vc = storyboard.instantiateViewController(withIdentifier: "WorkOrderDetailVC") as? WorkOrderDetailViewController {
                    vc.orderId = orderId
                    self.window?.rootViewController?.present(vc, animated: true)
                }
                
            default:
                // Ë∑≥ËΩ¨Âà∞ÈÄöÁü•‰∏≠ÂøÉ
                if let vc = storyboard.instantiateViewController(withIdentifier: "NotificationCenterVC") as? NotificationCenterViewController {
                    self.window?.rootViewController?.present(vc, animated: true)
                }
            }
        }
    }
}
```

---

## ËÆæÂ§áÊ≥®ÂÜåÊµÅÁ®ã

### ÊµÅÁ®ãÂõæ
```
APPÂêØÂä®
  ‚Üì
ÂàùÂßãÂåñJPush SDK
  ‚Üì
Ëé∑ÂèñRegistration ID
  ‚Üì
Ë∞ÉÁî®ËÆæÂ§áÊ≥®ÂÜåAPI (/api/app-device-register)
  ‚Üì
ÊúçÂä°Âô®‰øùÂ≠òËÆæÂ§á‰ø°ÊÅØ
  ‚Üì
ËÆæÁΩÆÁî®Êà∑Âà´Âêç(ÂèØÈÄâ)
  ‚Üì
ËÆ¢ÈòÖÊ†áÁ≠æ(ÂèØÈÄâ)
  ‚Üì
ÂáÜÂ§áÊé•Êî∂Êé®ÈÄÅ
```

### ËÆæÂ§áÊ≥®ÂÜåÊó∂Êú∫
1. **È¶ñÊ¨°ÂÆâË£ÖÂêØÂä®**ÔºöÂøÖÈ°ªÊ≥®ÂÜå
2. **Áî®Êà∑ÁôªÂΩïÊàêÂäü**ÔºöÊõ¥Êñ∞Áî®Êà∑ÂÖ≥ËÅî
3. **APPÁâàÊú¨Êõ¥Êñ∞**ÔºöÊõ¥Êñ∞ËÆæÂ§á‰ø°ÊÅØ
4. **Registration IDÂèòÂåñ**ÔºöÈáçÊñ∞Ê≥®ÂÜå

---

## APIÊé•Âè£ÊñáÊ°£

### 1. ËÆæÂ§áÊ≥®ÂÜåÊé•Âè£

**POST** `/api/app-device-register`

Ê≥®ÂÜåÊàñÊõ¥Êñ∞ÁßªÂä®ËÆæÂ§á‰ø°ÊÅØÔºåÁî®‰∫éÊé®ÈÄÅÈÄöÁü•„ÄÇ

#### ËØ∑Ê±ÇÂ§¥
```http
Content-Type: application/json
Authorization: Bearer {token}
```

#### ËØ∑Ê±ÇÂèÇÊï∞
| ÂèÇÊï∞ | Á±ªÂûã | ÂøÖÂ°´ | ËØ¥Êòé |
|-----|------|-----|------|
| jpush_registration_id | string | ÊòØ | ÊûÅÂÖâÊé®ÈÄÅÊ≥®ÂÜåID |
| device_type | string | ÊòØ | ËÆæÂ§áÁ±ªÂûã(iOS/Android) |
| device_model | string | Âê¶ | ËÆæÂ§áÂûãÂè∑ |
| os_version | string | Âê¶ | Êìç‰ΩúÁ≥ªÁªüÁâàÊú¨ |
| app_version | string | Âê¶ | APPÁâàÊú¨Âè∑ |

#### ËØ∑Ê±ÇÁ§∫‰æã
```json
{
  "jpush_registration_id": "1a0018970a5964b3582",
  "device_type": "iOS",
  "device_model": "iPhone 13 Pro",
  "os_version": "15.5",
  "app_version": "1.2.0",
}
```

#### ÂìçÂ∫îÁ§∫‰æã
```json
{
  "success": true,
  "data": {
    "device_id": "DEV_001",
    "user_id": "USER001",
    "is_active": true,
    "created_at": "2025-01-19T08:00:00Z"
  },
  "message": "ËÆæÂ§áÊ≥®ÂÜåÊàêÂäü"
}
```

### 2. ËÆæÂ§áÊ≥®ÈîÄÊé•Âè£

**POST** `/api/app-device-unregister`

Áî®Êà∑ÁôªÂá∫ÊàñÂç∏ËΩΩAPPÊó∂Ê≥®ÈîÄËÆæÂ§á„ÄÇ

#### ËØ∑Ê±ÇÂèÇÊï∞
| ÂèÇÊï∞ | Á±ªÂûã | ÂøÖÂ°´ | ËØ¥Êòé |
|-----|------|-----|------|
| jpush_registration_id | string | Âê¶ | ÊûÅÂÖâÊé®ÈÄÅÊ≥®ÂÜåID |
| device_id | string | Âê¶ | ËÆæÂ§áID(‰∫åÈÄâ‰∏Ä) |

### 3. Ëé∑ÂèñÈÄöÁü•ÂàóË°®

**GET** `/api/app-notifications`

Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑÈÄöÁü•ÂàóË°®„ÄÇ

#### Êü•ËØ¢ÂèÇÊï∞
| ÂèÇÊï∞ | Á±ªÂûã | ÈªòËÆ§ÂÄº | ËØ¥Êòé |
|-----|------|-------|------|
| page | number | 1 | È°µÁ†Å |
| limit | number | 20 | ÊØèÈ°µÊï∞Èáè |
| status | string | all | Áä∂ÊÄÅ(all/read/unread) |
| type | string | all | Á±ªÂûã(all/alarm/workorder/system) |

#### ÂìçÂ∫îÁ§∫‰æã
```json
{
  "success": true,
  "data": {
    "notifications": [
      {
        "id": "N001",
        "title": "Êñ∞ÂëäË≠¶ÈÄöÁü•",
        "content": "Ê£ÄÊµãÂà∞Ê∞¥Ë¥®ÂºÇÂ∏∏ÂëäË≠¶",
        "type": "alarm",
        "priority": "high",
        "is_read": false,
        "created_at": "2025-01-19T08:00:00Z",
        "action_url": "/alarms/ALARM001"
      }
    ],
    "unread_count": 5,
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 50
    }
  }
}
```

### 4. Ê†áËÆ∞ÈÄöÁü•Â∑≤ËØª

**PUT** `/api/app-notifications/{id}/read`

Ê†áËÆ∞ÊåáÂÆöÈÄöÁü•‰∏∫Â∑≤ËØª„ÄÇ

### 5. ÊâπÈáèÊ†áËÆ∞Â∑≤ËØª

**PUT** `/api/app-notifications/read-all`

Ê†áËÆ∞ÊâÄÊúâÈÄöÁü•‰∏∫Â∑≤ËØª„ÄÇ

### 6. Ëé∑ÂèñÊú™ËØªÊï∞Èáè

**GET** `/api/app-notifications/unread-count`

Ëé∑ÂèñÊú™ËØªÈÄöÁü•Êï∞ÈáèÔºåÁî®‰∫éAPPËßíÊ†áÊòæÁ§∫„ÄÇ

#### ÂìçÂ∫îÁ§∫‰æã
```json
{
  "success": true,
  "data": {
    "unread_count": 5,
    "alarm_count": 2,
    "workorder_count": 3
  }
}
```

### 7. Êé®ÈÄÅÂÅèÂ•ΩËÆæÁΩÆ

**GET** `/api/app-push-settings`
**PUT** `/api/app-push-settings`

Ëé∑ÂèñÂíåÊõ¥Êñ∞Áî®Êà∑ÁöÑÊé®ÈÄÅÂÅèÂ•ΩËÆæÁΩÆ„ÄÇ

#### ËÆæÁΩÆÂèÇÊï∞
```json
{
  "enable_push": true,
  "alarm_push": true,
  "workorder_push": true,
  "system_push": true,
  "quiet_hours": {
    "enabled": true,
    "start_time": "22:00",
    "end_time": "08:00"
  },
  "priority_filter": ["urgent", "high", "normal"]
}
```

---

## Êé®ÈÄÅÊ∂àÊÅØÂ§ÑÁêÜ

### Ê∂àÊÅØÊ®°ÊùøÁ±ªÂûã

| Ê®°Êùø‰ª£Á†Å | ËØ¥Êòé | Ë∑≥ËΩ¨È°µÈù¢ |
|---------|------|---------|
| ALARM_NEW | Êñ∞ÂëäË≠¶ÈÄöÁü• | ÂëäË≠¶ËØ¶ÊÉÖÈ°µ |
| ALARM_CONFIRMED | ÂëäË≠¶Á°ÆËÆ§ÈÄöÁü• | ÂëäË≠¶ËØ¶ÊÉÖÈ°µ |
| ALARM_RESOLVED | ÂëäË≠¶Ëß£ÂÜ≥ÈÄöÁü• | ÂëäË≠¶ËØ¶ÊÉÖÈ°µ |
| WORKORDER_ASSIGNED | Â∑•ÂçïÂàÜÈÖçÈÄöÁü• | Â∑•ÂçïËØ¶ÊÉÖÈ°µ |
| WORKORDER_REASSIGNED | Â∑•ÂçïËΩ¨Ê¥æÈÄöÁü• | Â∑•ÂçïËØ¶ÊÉÖÈ°µ |
| WORKORDER_URGING | Â∑•ÂçïÂÇ¨ÂäûÈÄöÁü• | Â∑•ÂçïËØ¶ÊÉÖÈ°µ |
| WORKORDER_COMPLETED | Â∑•ÂçïÂÆåÊàêÈÄöÁü• | Â∑•ÂçïËØ¶ÊÉÖÈ°µ |
| INSPECTION_REMINDER | Â∑°Ê£ÄÊèêÈÜí | Â∑°Ê£Ä‰ªªÂä°È°µ |
| INSPECTION_OVERDUE | Â∑°Ê£ÄË∂ÖÊó∂ÊèêÈÜí | Â∑°Ê£Ä‰ªªÂä°È°µ |
| SYSTEM_NOTIFICATION | Á≥ªÁªüÈÄöÁü• | ÈÄöÁü•ËØ¶ÊÉÖÈ°µ |
| SYSTEM_ANNOUNCEMENT | Á≥ªÁªüÂÖ¨Âëä | ÂÖ¨ÂëäËØ¶ÊÉÖÈ°µ |

### Ê∂àÊÅØextrasÂ≠óÊÆµ

```json
{
  "template_code": "ALARM_NEW",
  "notification_id": "N001",
  "alarm_id": "ALARM001",
  "action_url": "/alarms/ALARM001",
  "priority": "high",
  "timestamp": "2025-01-19T08:00:00Z"
}
```

### Â§ÑÁêÜÊµÅÁ®ã

```javascript
// Áªü‰∏ÄÁöÑÊ∂àÊÅØÂ§ÑÁêÜÂáΩÊï∞
function handlePushMessage(message) {
  const { title, content, extras } = message
  
  // 1. ÊòæÁ§∫Êú¨Âú∞ÈÄöÁü•ÔºàÂ¶ÇÊûúAPPÂú®ÂêéÂè∞Ôºâ
  if (AppState.currentState !== 'active') {
    showLocalNotification(title, content)
  }
  
  // 2. Êõ¥Êñ∞Êú™ËØªÊï∞Èáè
  updateBadgeCount()
  
  // 3. Âà∑Êñ∞ÈÄöÁü•ÂàóË°®
  refreshNotificationList()
  
  // 4. Â§ÑÁêÜÁâπÂÆö‰∏öÂä°ÈÄªËæë
  switch (extras.template_code) {
    case 'ALARM_NEW':
      // Êí≠ÊîæÂëäË≠¶Èü≥
      playAlarmSound()
      // ÊòæÁ§∫ÂëäË≠¶ÂºπÁ™ó
      showAlarmAlert(extras)
      break
      
    case 'WORKORDER_ASSIGNED':
      // Âà∑Êñ∞Â∑•ÂçïÂàóË°®
      refreshWorkOrderList()
      break
  }
  
  // 5. ‰∏äÊä•Êé•Êî∂ÁªüËÆ°
  reportPushReceived(extras.notification_id)
}
```

---

## ÊµãËØï‰∏éË∞ÉËØï

### 1. ÂºÄÂèëÁéØÂ¢ÉÊµãËØï

#### Ëé∑ÂèñÊµãËØïËÆæÂ§áÁöÑRegistration ID
```bash
# iOSÊ®°ÊãüÂô®‰∏çÊîØÊåÅÊé®ÈÄÅÔºåÈúÄË¶ÅÁúüÊú∫
# AndroidÂèØ‰ª•‰ΩøÁî®Ê®°ÊãüÂô®

# Êü•ÁúãÊó•Âøó‰∏≠ÁöÑRegistration ID
adb logcat | grep JPush
```

#### ‰ΩøÁî®ÊûÅÂÖâÊé®ÈÄÅÊéßÂà∂Âè∞ÊµãËØï
1. ÁôªÂΩï [ÊûÅÂÖâÊé®ÈÄÅÊéßÂà∂Âè∞](https://www.jiguang.cn)
2. ÈÄâÊã©Â∫îÁî®
3. ËøõÂÖ•"Êé®ÈÄÅ" -> "ÂèëÈÄÅÈÄöÁü•"
4. ÈÄâÊã©ÁõÆÊ†áÔºàRegistration ID/Âà´Âêç/Ê†áÁ≠æÔºâ
5. Â°´ÂÜôÊé®ÈÄÅÂÜÖÂÆπ
6. ÁÇπÂáªÂèëÈÄÅ

### 2. ÊµãËØïAPI

**POST** `/api/app-push-test`

ÂèëÈÄÅÊµãËØïÊé®ÈÄÅÂà∞ÊåáÂÆöËÆæÂ§á„ÄÇ

```json
{
  "registration_id": "1a0018970a5964b3582",
  "title": "ÊµãËØïÊé®ÈÄÅ",
  "content": "ËøôÊòØ‰∏ÄÊù°ÊµãËØïÊ∂àÊÅØ",
  "template_code": "SYSTEM_NOTIFICATION"
}
```

### 3. ÂÆûÈôÖÊµãËØïÁ§∫‰æã

#### ÊµãËØïËÆæÂ§áÊ≥®ÂÜå
```bash
curl -X POST http://localhost:3001/api/app-device-register \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "jpush_registration_id": "1a0018970a5964b3582",
    "device_type": "iOS",
    "device_model": "iPhone 13 Pro",
    "os_version": "15.5",
    "app_version": "1.0.0"
  }'
```

#### ÊµãËØïÊé®ÈÄÅÂèëÈÄÅ
```bash
curl -X POST http://localhost:3001/api/app-push-send \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "target_user_ids": ["USER001"],
    "title": "ÊµãËØïÊé®ÈÄÅ",
    "content": "ËøôÊòØ‰∏ÄÊù°ÊµãËØïÊ∂àÊÅØ",
    "priority": "high"
  }'
```

### 4. Â∏∏ËßÅÈóÆÈ¢ò

#### Q: iOSÊî∂‰∏çÂà∞Êé®ÈÄÅ
A: Ê£ÄÊü•‰ª•‰∏ãÂá†ÁÇπÔºö
- ËØÅ‰π¶ÊòØÂê¶Ê≠£Á°ÆÈÖçÁΩÆ
- aps-environmentÊòØÂê¶Ê≠£Á°ÆÔºàdevelopment/productionÔºâ
- ËÆæÂ§áÊòØÂê¶ÂÖÅËÆ∏ÈÄöÁü•ÊùÉÈôê
- Registration IDÊòØÂê¶ÊúâÊïà

#### Q: AndroidÊé®ÈÄÅÂª∂Ëøü
A: ÂèØËÉΩÂéüÂõ†Ôºö
- ËÆæÂ§áÂ§Ñ‰∫éÁúÅÁîµÊ®°Âºè
- APPË¢´Á≥ªÁªüÊùÄÊ≠ª
- ÁΩëÁªú‰∏çÁ®≥ÂÆö
- ÈúÄË¶ÅÈÖçÁΩÆÂéÇÂïÜÈÄöÈÅìÔºàÂ∞èÁ±≥„ÄÅÂçé‰∏∫„ÄÅOPPOÁ≠âÔºâ

#### Q: Registration IDËé∑ÂèñÂ§±Ë¥•
A: Ëß£ÂÜ≥ÊñπÊ°àÔºö
- Ê£ÄÊü•ÁΩëÁªúËøûÊé•
- Á°ÆËÆ§AppKeyÈÖçÁΩÆÊ≠£Á°Æ
- Ê∏ÖÈô§APPÊï∞ÊçÆÈáçËØï
- Âª∂ËøüËé∑ÂèñÔºàÂàùÂßãÂåñÂêé1-2ÁßíÔºâ

#### Q: ËÆæÂ§áÊ≥®ÂÜåÂ§±Ë¥•
A: Ê£ÄÊü•‰ª•‰∏ãÂ≠óÊÆµÊòØÂê¶Ê≠£Á°ÆÔºö
- `mobile_devices`Ë°®Â≠óÊÆµÔºö`device_token`ÔºàÈùû`push_token`Ôºâ
- `mobile_devices`Ë°®Â≠óÊÆµÔºö`last_active`ÔºàÈùû`last_active_at`Ôºâ
- Ë°®‰∏≠‰∏çÂ≠òÂú®`device_name`Âíå`push_enabled`Â≠óÊÆµ

### 5. Êó•ÂøóÊî∂ÈõÜ

```javascript
// ÂºÄÂêØJPushÊó•Âøó
JPush.setLoggerEnable(true)

// Ëá™ÂÆö‰πâÊó•Âøó‰∏äÊä•
function logPushEvent(event, data) {
  const log = {
    event,
    data,
    timestamp: new Date().toISOString(),
    device_id: getDeviceId(),
    user_id: getUserId()
  }
  
  // ‰∏äÊä•Âà∞ÊúçÂä°Âô®
  fetch('/api/app-push-logs', {
    method: 'POST',
    body: JSON.stringify(log)
  })
}
```

---

## ÈôÑÂΩï

### Êé®ÈÄÅÈôêÂà∂
- ÂçïÊ¨°Êé®ÈÄÅÁõÆÊ†áÁî®Êà∑Êï∞Ôºö1000
- Êé®ÈÄÅÈ¢ëÁéáÈôêÂà∂Ôºö600Ê¨°/ÂàÜÈíü
- Ê∂àÊÅØÂ§ßÂ∞èÈôêÂà∂Ôºö4KB
- Á¶ªÁ∫øÊ∂àÊÅØ‰øùÂ≠òÔºö1Â§©

### Êï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ

#### mobile_devices Ë°®
```sql
CREATE TABLE mobile_devices (
    id VARCHAR(20) PRIMARY KEY,           -- ËÆæÂ§áÂîØ‰∏ÄÊ†áËØÜ
    user_id VARCHAR(20) NOT NULL,         -- Áî®Êà∑ID
    device_type VARCHAR(20),              -- ËÆæÂ§áÁ±ªÂûã(iOS/Android)
    device_model VARCHAR(50),             -- ËÆæÂ§áÂûãÂè∑
    os_version VARCHAR(20),               -- Êìç‰ΩúÁ≥ªÁªüÁâàÊú¨
    app_version VARCHAR(20),              -- APPÁâàÊú¨
    device_token VARCHAR(255),            -- ËÆæÂ§á‰ª§Áâå
    jpush_registration_id VARCHAR(255),   -- ÊûÅÂÖâÊé®ÈÄÅÊ≥®ÂÜåID
    is_active BOOLEAN DEFAULT true,       -- ÊòØÂê¶Ê¥ªË∑É
    last_active TIMESTAMP WITH TIME ZONE, -- ÊúÄÂêéÊ¥ªË∑ÉÊó∂Èó¥
    created_at TIMESTAMP WITH TIME ZONE,  -- ÂàõÂª∫Êó∂Èó¥
    updated_at TIMESTAMP WITH TIME ZONE   -- Êõ¥Êñ∞Êó∂Èó¥
);
```

Ê≥®ÊÑèÔºö
- ‰ΩøÁî® `device_token` ËÄåÈùû `push_token`
- ‰ΩøÁî® `last_active` ËÄåÈùû `last_active_at`
- ‰∏çÂ≠òÂú® `device_name` Âíå `push_enabled` Â≠óÊÆµ

### Áõ∏ÂÖ≥ÈìæÊé•
- [ÊûÅÂÖâÊé®ÈÄÅÂÆòÊñπÊñáÊ°£](https://docs.jiguang.cn/jpush/guideline/intro)
- [React Native SDKÊñáÊ°£](https://github.com/jpush/jpush-react-native)
- [Android SDKÊñáÊ°£](https://docs.jiguang.cn/jpush/client/Android/android_sdk)
- [iOS SDKÊñáÊ°£](https://docs.jiguang.cn/jpush/client/iOS/ios_sdk)

### ÊäÄÊúØÊîØÊåÅ
- ÂÜÖÈÉ®ÊîØÊåÅÔºöadmin@smartriver.com
- ÊûÅÂÖâÊäÄÊúØÊîØÊåÅÔºösupport@jiguang.cn